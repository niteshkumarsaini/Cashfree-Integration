<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Checkout - SoundWave</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

	<style>
		body {
			background: linear-gradient(135deg, #f4f7fe, #ddeeff);
			height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		}

		.checkout-card {
			background: #fff;
			padding: 2.5rem;
			border-radius: 20px;
			box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
			width: 100%;
			max-width: 500px;
			text-align: center;
		}

		.checkout-card h3 {
			font-weight: bold;
			color: #333;
			margin-bottom: 30px;
		}

		.form-control,
		.form-select {
			border-radius: 12px;
			padding: 10px 15px;
		}

		.btn-custom {
			background: linear-gradient(to right, #5f27cd, #341f97);
			color: white;
			border: none;
			border-radius: 12px;
			padding: 12px 20px;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.btn-custom:hover {
			background: linear-gradient(to right, #341f97, #5f27cd);
			transform: translateY(-2px);
		}

		.music-icon {
			font-size: 40px;
			color: #5f27cd;
			margin-bottom: 10px;
		}
	</style>
</head>

<body>

	<div class="checkout-card">
		<div class="music-icon">
			<i class="bi bi-music-note-beamed"></i>
		</div>
		<h3>SoundWave Checkout</h3>
		<form id="checkoutForm">
			<div class="mb-3 text-start">
				<label for="ordAmt" class="form-label">Order Amount</label>
				<input type="number" step="0.01" class="form-control" id="ordAmt" name="ordAmt"
					placeholder="Enter amount" required>
			</div>
			<div class="mb-4 text-start">
				<label for="ordCurrency" class="form-label">Currency</label>
				<select class="form-select" id="ordCurrency" name="ordCurrency">
					<option value="INR" selected>INR</option>
					<option value="USD">USD</option>
					<option value="EUR">EUR</option>
				</select>
			</div>
			<button type="button" onclick="initiateCheckout()" class="btn btn-custom w-100">
				<i class="bi bi-arrow-right-circle me-2"></i>Proceed to Pay
			</button>
		</form>
	</div>
	<script>
		const cashfree = Cashfree({
			mode: "sandbox" // switch to "production" for live
		});
		function initiateCheckout() {
			const form = document.getElementById("checkoutForm");
			const formData = new FormData(form);

			fetch('/order/create', {
				method: 'POST',
				body: formData
			})
				.then(res => res.json())
				.then(data => {
					console.log('Order Response:', data);

					if (data.paymentSessionId) {
						const checkoutOptions = {
							paymentSessionId: data.paymentSessionId,
							redirectTarget: "_self"
						};

						cashfree.checkout(checkoutOptions).then((transactionResponse) => {
							console.log("Transaction Response:", transactionResponse);

							// You can POST this to your backend or redirect manually
							const orderId = data.ordId;
							//calling backend for payment initiate
							fetch("/transaction/initiate", {
								method: 'POST',
								body: JSON.stringify(data),
								headers: {
									'Content-Type': 'application/json'
								}
							}).then((response) => response.json()).then((mydata) => {
								console.log(mydata)

							})

							// Redirect manually with status (recommended)
							const paymentStatus = transactionResponse.payment.status; // e.g. "SUCCESS", "FAILED", "PENDING"
							const redirectUrl = `/payment-status?order_id=${orderId}&status=${paymentStatus}`;
							fetch("/transaction/initiate", {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify(data)
							}).then((response) => response.json()).then(mydata => {
								console.log("Success", mydata)
							})
							// window.location.href = redirectUrl;
						});
					} else {
						alert("Payment session not received.");
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert("Something went wrong!");
				});
		}

	</script>

</body>

</html>